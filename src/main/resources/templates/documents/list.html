<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="documents.page.title">Quản lý Tài liệu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loading-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .error-container {
            display: none;
        }
        /* Đảm bảo các phần tử ẩn khi chưa khởi tạo xong */
        [data-i18n]:not([data-i18n-init]) {
            visibility: hidden;
        }
    </style>
</head>
<body>
<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-container">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2" data-i18n="documents.loading">Đang tải dữ liệu...</p>
    </div>
</div>

<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-alt me-2"></i><span data-i18n="documents.page.heading">Quản lý Tài liệu</span></h2>
        <a th:href="@{/documents/create}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i><span data-i18n="documents.page.add_button">Thêm tài liệu</span>
        </a>
    </div>

    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form th:action="@{/documents/search}" method="get" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label" data-i18n="documents.search.author_label">Tìm kiếm theo tác giả</label>
                    <input type="text" name="author" class="form-control"
                           data-i18n="documents.search.author_placeholder"
                           placeholder="Nhập tên tác giả..." th:value="${searchAuthor}">
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="documents.search.subject_label">Lọc theo môn học</label>
                    <select name="subjectId" class="form-select">
                        <option value="" data-i18n="documents.search.all_subjects">Tất cả môn học</option>
                        <option th:each="subject : ${subjects}"
                                th:if="${subjects != null}"
                                th:value="${subject.id}"
                                th:text="${subject.name}"
                                th:selected="${param.subjectId == subject.id}">
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="fas fa-search me-1"></i><span data-i18n="documents.search.button">Tìm kiếm</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Documents List -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th data-i18n="documents.table.header.title">Tiêu đề</th>
                        <th data-i18n="documents.table.header.author">Tác giả</th>
                        <th data-i18n="documents.table.header.subject">Môn học</th>
                        <th data-i18n="documents.table.header.file_type">Loại file</th>
                        <th data-i18n="documents.table.header.upload_date">Ngày upload</th>
                        <th data-i18n="documents.table.header.actions">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${documents != null and !documents.empty}"
                        th:each="document : ${documents}"
                        th:class="${document.downloadCount > 10} ? 'table-warning'">
                        <td>
                            <strong th:text="${document.title}"></strong>
                            <br>
                            <small class="text-muted">
                                <span th:if="${document.description != null and !document.description.isEmpty()}"
                                      th:text="${document.description}"></span>
                                <span th:unless="${document.description != null and !document.description.isEmpty()}"
                                      data-i18n="documents.table.no_description">Không có mô tả</span>
                            </small>
                        </td>
                        <td th:text="${document.author} ?: 'N/A'"></td>
                        <td>
                            <span class="badge bg-primary"
                                  th:text="${document.subject?.name} ?: 'N/A'"></span>
                        </td>
                        <td>
                            <span class="badge bg-secondary"
                                  th:text="${document.fileType} ?: 'Unknown'"></span>
                        </td>
                        <td th:text="${#temporals.format(document.uploadDate, 'dd/MM/yyyy HH:mm')}"></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a th:href="@{/documents/edit/{id}(id=${document.id})}"
                                   class="btn btn-outline-warning"
                                   data-i18n-title="documents.table.edit_tooltip"
                                   title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a th:href="@{/documents/delete/{id}(id=${document.id})}"
                                   class="btn btn-outline-danger"
                                   data-i18n-title="documents.table.delete_tooltip"
                                   title="Xóa"
                                   onclick="return confirmDelete()">
                                    <i class="fas fa-trash"></i>
                                </a>
                                <a th:href="@{/documents/{id}(id=${document.id})}"
                                   class="btn btn-info btn-sm"
                                   data-i18n="documents.table.details_button">
                                    <i class="fas fa-eye"></i> <span data-i18n="documents.table.details_button_text">Chi tiết</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${documents == null or documents.empty}">
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p data-i18n="documents.table.empty_message">Không có tài liệu nào.</p>
                            <a th:href="@{/documents/create}" class="btn btn-primary" data-i18n="documents.table.add_first_button">
                                Thêm tài liệu đầu tiên
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<!-- Translation Script - Đảm bảo an toàn -->
<script>
    // Kiểm tra xem script đã được chạy chưa
    if (typeof window.translationInitialized === 'undefined') {
        window.translationInitialized = true;

        // Dictionary đa ngôn ngữ
        const translations = {
            vi: {
                // Documents page
                'documents.page.title': 'Quản lý Tài liệu',
                'documents.page.heading': 'Quản lý Tài liệu',
                'documents.page.add_button': 'Thêm tài liệu',

                'documents.search.author_label': 'Tìm kiếm theo tác giả',
                'documents.search.author_placeholder': 'Nhập tên tác giả...',
                'documents.search.subject_label': 'Lọc theo môn học',
                'documents.search.all_subjects': 'Tất cả môn học',
                'documents.search.button': 'Tìm kiếm',

                'documents.table.header.title': 'Tiêu đề',
                'documents.table.header.author': 'Tác giả',
                'documents.table.header.subject': 'Môn học',
                'documents.table.header.file_type': 'Loại file',
                'documents.table.header.upload_date': 'Ngày upload',
                'documents.table.header.actions': 'Thao tác',
                'documents.table.no_description': 'Không có mô tả',
                'documents.table.details_button_text': 'Chi tiết',
                'documents.table.empty_message': 'Không có tài liệu nào.',
                'documents.table.add_first_button': 'Thêm tài liệu đầu tiên',
                'documents.table.edit_tooltip': 'Sửa',
                'documents.table.delete_tooltip': 'Xóa',

                'documents.delete.confirm': 'Bạn có chắc chắn muốn xóa tài liệu này?',
                'documents.loading': 'Đang tải dữ liệu...'
            },
            en: {
                'documents.page.title': 'Document Management',
                'documents.page.heading': 'Document Management',
                'documents.page.add_button': 'Add Document',

                'documents.search.author_label': 'Search by author',
                'documents.search.author_placeholder': 'Enter author name...',
                'documents.search.subject_label': 'Filter by subject',
                'documents.search.all_subjects': 'All subjects',
                'documents.search.button': 'Search',

                'documents.table.header.title': 'Title',
                'documents.table.header.author': 'Author',
                'documents.table.header.subject': 'Subject',
                'documents.table.header.file_type': 'File Type',
                'documents.table.header.upload_date': 'Upload Date',
                'documents.table.header.actions': 'Actions',
                'documents.table.no_description': 'No description',
                'documents.table.details_button_text': 'Details',
                'documents.table.empty_message': 'No documents found.',
                'documents.table.add_first_button': 'Add First Document',
                'documents.table.edit_tooltip': 'Edit',
                'documents.table.delete_tooltip': 'Delete',

                'documents.delete.confirm': 'Are you sure you want to delete this document?',
                'documents.loading': 'Loading data...'
            }
        };

        // Hàm lấy translation an toàn
        function getTranslation(key) {
            try {
                const savedLang = localStorage.getItem('preferredLanguage') || 'vi';
                return translations[savedLang]?.[key] || translations.vi[key] || key;
            } catch (error) {
                console.warn('Translation error:', error);
                return key;
            }
        }

        // Hàm chuyển đổi ngôn ngữ an toàn
        function changeLanguage(lang) {
            try {
                // Validate language
                if (!translations[lang]) {
                    lang = 'vi';
                }

                // Lưu ngôn ngữ
                localStorage.setItem('preferredLanguage', lang);

                // Cập nhật thuộc tính lang
                document.documentElement.lang = lang;

                // Cập nhật tất cả elements có data-i18n
                const dict = translations[lang];
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    try {
                        const key = element.getAttribute('data-i18n');
                        if (dict && dict[key]) {
                            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                                element.placeholder = dict[key];
                            } else if (element.tagName === 'TITLE') {
                                document.title = dict[key];
                            } else {
                                element.textContent = dict[key];
                            }
                            element.setAttribute('data-i18n-init', 'true');
                        }
                    } catch (e) {
                        console.warn('Error updating element:', e);
                    }
                });

                // Cập nhật tooltips
                document.querySelectorAll('[data-i18n-title]').forEach(element => {
                    try {
                        const key = element.getAttribute('data-i18n-title');
                        if (dict && dict[key]) {
                            element.title = dict[key];
                        }
                    } catch (e) {
                        console.warn('Error updating title:', e);
                    }
                });

            } catch (error) {
                console.error('Language change error:', error);
            }
        }

        // Hàm khởi tạo ngôn ngữ
        function initLanguage() {
            try {
                // Hiển thị loading
                const loadingEl = document.getElementById('loadingOverlay');
                if (loadingEl) loadingEl.style.display = 'flex';

                // Đợi DOM ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        applyLanguage();
                    });
                } else {
                    applyLanguage();
                }

                function applyLanguage() {
                    try {
                        const savedLang = localStorage.getItem('preferredLanguage') || 'vi';
                        changeLanguage(savedLang);

                        // Ẩn loading sau khi áp dụng ngôn ngữ
                        setTimeout(() => {
                            if (loadingEl) loadingEl.style.display = 'none';

                            // Hiển thị tất cả phần tử đã được dịch
                            document.querySelectorAll('[data-i18n]').forEach(el => {
                                el.style.visibility = 'visible';
                            });
                        }, 100);

                    } catch (error) {
                        console.error('Apply language error:', error);
                        if (loadingEl) loadingEl.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error('Init language error:', error);
            }
        }

        // Hàm xác nhận xóa
        function confirmDelete() {
            try {
                const message = getTranslation('documents.delete.confirm');
                return confirm(message);
            } catch (error) {
                return confirm('Bạn có chắc chắn muốn xóa?');
            }
        }

        // Khởi tạo khi trang load
        try {
            initLanguage();

            // Xử lý nút chuyển ngôn ngữ (nếu có trong header)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.language-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.language-btn');
                    const lang = btn.getAttribute('data-lang');
                    if (lang) {
                        changeLanguage(lang);
                    }
                }
            });

            // Fallback: nếu có lỗi, ẩn loading sau 3s
            setTimeout(() => {
                const loadingEl = document.getElementById('loadingOverlay');
                if (loadingEl && loadingEl.style.display !== 'none') {
                    loadingEl.style.display = 'none';
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        el.style.visibility = 'visible';
                    });
                }
            }, 3000);

        } catch (error) {
            console.error('Initialization error:', error);
            // Fallback: hiển thị trang với ngôn ngữ mặc định
            const loadingEl = document.getElementById('loadingOverlay');
            if (loadingEl) loadingEl.style.display = 'none';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.style.visibility = 'visible';
            });
        }
    }
</script>
</body>
</html>